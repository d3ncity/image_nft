<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image NFT: Client-Side Page</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="module" src="../web3.min.js"></script>
    <script src="./Image.json"></script>
</head>
<body>
    <form action="javascript:createNFT()">
        <h2>Create a new NFT Here:</h2>
        <!-- <label for="address">Address:</label> -->
        <!-- <input type="text" id="address" name="address"><br><br> -->
        <label for="ID">ID:</label>
        <input type="text" id="ID" name="ID"><br><br>
        <label for="amount">Quantity:</label>
        <input type="text" id="amount" name="amount""><br><br>
        <label for="url">uri:</label>
        <input type="text" id="url" name="url" placeholder="ipfs://"><br><br>
        <input type="submit" value="Submit">
    </form>

    <div id="all-retrieved-data">
    </div>



    <script type="text/javascript">

        var account = "";
        var totalSupply = 0;
        var images = [];
        var contract;
        var Image;
        $.getJSON("./Image.json", (returnedValue)=> {console.log("Successfully retreived Image Contract json object."); Image = returnedValue;});

        function received(){
            console.log("Received these parameters: " + "ID=" + $("#ID").val() + "and amount=" + $("#amount").val() + " and url=" + $("#url").val());
        }

        function getPinataAttributes(pinataJSON){
            var formattedString = '';
            for(i=0; i<pinataJSON.attributes.length; i++){
                formattedString += pinataJSON.attributes[i].trait_type + ": " + pinataJSON.attributes[i].value + " <br> ";
            }
            // console.log(formattedString);
            return formattedString;
        }

        function getPinataImgSrc(pinataJSON){
            const baseURL = 'https://gateway.pinata.cloud/ipfs/';
            // console.log(baseURL + pinataJSON.image.split('://')[1]);
            return baseURL + pinataJSON.image.split('://')[1];
        }

        function updatePage(){
            console.log("Updating the page...");
            location.reload();
        }

        async function createNFT(){
            console.log("Attempting to create an NFT...");
            received();
            
            console.log("Account being used: ");
            console.log(account);
            contract.methods.createNFT($('#ID').val(), $('#amount').val(), 
            '0x0', $('#url').val()).send({ from: account, gasLimit: 210000, gas:1000000});
            // updatePage();
        }

        async function getExistingNFTs(){
            const baseURL = 'https://gateway.pinata.cloud/ipfs/';
            var pinataJSON;
            const totalSupply = await contract.methods.getTotalSupply().call();
            console.log("TotalSupply=" + totalSupply);
            
            if(totalSupply>0){
                const allIDs = await contract.methods.getAllIDs().call();
                var currentURI = '';
                for(var i = 0; i<totalSupply; i++){
                    currentURI = await contract.methods.uri(allIDs[i]).call();
                    var id = allIDs[i];
                    var added = baseURL + currentURI.split('://')[1];
                    $.getJSON(added, (returnedValue)=> {
                        console.log("Successfully retreived json object from pinata."); 
                        pinataJSON = returnedValue;
                        console.log("Appending:" + pinataJSON.name);
                        $('#all-retrieved-data').append('<div border-color="black"><h4> Name: '+pinataJSON.name+'</h4>'+
                                                            '<p> Description: '+pinataJSON.description+'</p>'+
                                                            '<p> URI: '+pinataJSON.image+'</p>'+
                                                            '<p>'+ getPinataAttributes(pinataJSON) +'</p>'+
                                                            '<img src=' + getPinataImgSrc(pinataJSON) +' height=500, width=400/>'+
                                                            `<form action=\"javascript:changeURI(`+ id + `)\"> <label for=\"toChangeURI`+id+`\">Update Uri:</label><input type=\"text\" id=\"toChangeURI`+id+`\" name=\"toChangeURI\" placeholder=\"ipfs://\"><br><br><input type=\"submit\" value=\"Update URI\"></form>`+
                                                        '</div>' + '<br>')
                    });
                }
            }
            else{
                console.log("No NFTs created yet... Nothing to display here.")
            }
        }

        function changeURI(id){
            console.log("Changing URI of NFT with id=" + id + " to " + $('#toChangeURI'+id).val() );
            // if($('#toChangeURI'+id).val()!=undefined){
                console.log("am inside!");
                contract.methods.setIdURI(id, $('#toChangeURI'+id).val()).send({ from: account, gasLimit: 210000, gas:1000000});
            // }
            // updatePage();
        }

        async function loadWeb3(){
            console.log("loading web3...");
            if(window.ethereum){
                console.log("modern web3 usage branch");
                window.web3 = new Web3(window.ethereum);
                await window.ethereum.enable();
            }
            else if (window.web3){
                console.log("old web3 usage branch");
                window.web3 = new Web3(window.web3.currentProvider);
            }
            else{
                window.alert("Non-ethereum Browser being used. Install MetaMask!");
            }
        }

        async function loadBlockchain(){
            console.log("loading blockchain...");
            const web3 = window.web3;

            //get all accounts in metamask
            const ethaccounts = await web3.eth.getAccounts(); 

            //the eth account used from metamask
            account = ethaccounts[0];
            console.log("Account: ");
            console.log(account);

            // to find the correct address
            const networkId = await web3.eth.net.getId(); 
            console.log(networkId);

            const networkData = Image.networks[networkId];

            console.log(networkId);
            console.log(networkData);

            if(networkData){
                const abi = Image.abi;
                const address = networkData.address;
                const c = new web3.eth.Contract(abi, address);

                contract = c;

                console.log("The Image Contract: ");
                console.log(contract);
            }
            else{
                window.alert("The Smart Contract Image is not deployed on this network!");
            }
        }

        $('document').ready(
            async function connectToBlockchain(){
                console.log("blockchain initializing...");
                await loadWeb3();
                await loadBlockchain();
                getExistingNFTs();
            }
        );
    </script>
</body>
</html>